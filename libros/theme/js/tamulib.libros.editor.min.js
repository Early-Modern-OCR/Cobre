(function(a){var i=function(){var e=a(".editing li").length,b=a("dd.numPages").html(),c=a(".editing").parents(".filmstripWrapper").find(".slider").slider("option","max");a("dd.numPages").html(e);a("dd.numMissingPages").html(a(".editing li > div").length);try{b=parseInt(b)}catch(f){}b&&a(".editing").parents(".filmstripWrapper").find(".slider").slider("option","max",c+(e-b))},l=function(e,b){a.ajax({url:"/page/"+e+"/delete/",cache:false,dataType:"json",success:function(c,f,d){if(typeof c.deleted!="number"){alert("There was an error deleting the page");
return false}if(a.isFunction(b))return b(c,f,d)},error:function(){alert("There was an error deleting the page")}})},o=function(e){return l(e,function(b){a(".editing #page_"+b.deleted).remove();a("a.save_order").click();i();return true})},p=function(e){var b=a(".exterior #page_"+e),c=b.children("div").attr("id").replace("exterior_","");a.ajax({url:"/page/"+e+"/edit/",type:"POST",data:{sequence:"0",title:c,internal:"False"},success:function(f){if(typeof f.updated=="number"){b.find("img").remove();b.find("div.overlay").removeClass("overlay");
b.children("div").addClass("missingPage");k(b)}}})},m=function(e){a(e).draggable({connectToSortable:".editing",helper:"clone",revert:"invalid"})},k=function(e){a(e).droppable({accept:".editing li:has(img)"})},j=function(){var e=a("#annotations").data("annotations_scroll");if(e==null)e=false;a(".annotations a").unbind("click.bookreader_editor");if(e)a(".annotations a").bind("click.bookreader_editor",function(b){b.preventDefault();return q(a(this))});else{a(".annotations a").bind("click.bookreader_editor",
function(b){b.preventDefault();a(".pages").serialScroll("jump",parseInt(a(this).attr("href").replace("#","")))});a("#annotations").data("annotations_scroll",true)}a("#annotations").data("annotations_scroll",!e)},q=function(e){var b=parseInt(e.attr("id").replace("annotation_",""));a("#edit_annotation_"+b).length>0?a.facebox(a("#edit_annotation_"+b)):a.facebox(function(){a.get("/annotation/"+b+"/edit/",function(c){a.facebox('<div id="edit_annotation_'+b+'"><form id="edit_annotation_'+b+'_form" class="edit_annotation_form annotation_form" method="POST" action="/annotation/'+
b+'/edit/">'+c+'<p><input type="submit" name="submitAction" value="Save" /></p></form><p><a href="/annotation/'+b+'/delete/" class="delete_annotation">Delete this annotation</a></p></div>')})})},r=function(e){a.facebox(function(){a.get(e,function(b){a.facebox('<div><form class="add_annotation_form annotation_form" method="POST" action="'+e+'">'+b+'<p><input type="submit" name="submitAction" value="Save" /></p></form></div>')})})},n=function(e){a(e).droppable({accept:"ul.copy li"})};a(document).ready(function(){i();
a.facebox.settings.opacity=0.75;var e={slideshow:false,serialScroll:{offset:-58}};a(".pages").filmstrip(e);a(".exterior").filmstrip(e);a(".pages a").click(function(b){b.preventDefault()});a(".editing").sortable({items:"li",revert:true,forceHelperSize:true,forcePlaceholderSize:true,opacity:0.75,stop:function(b,c){if(c.item.hasClass("newBlankPage")){var f={internal:true,count:a('input[name="numberNewPages"]').val()};if(c.item.hasClass("syncPage"))f.title="Sync Page";a.ajax({url:a("a.add_page").attr("href"),
data:f,type:"POST",cache:false,dataType:"json",success:function(d){if(typeof d.added=="undefined")c.item.remove();else{c.item.removeClass("newBlankPage");if(typeof d.added=="number")d.added=[d.added];c.item.attr("id","page_"+d.added[0]);for(var g=1;g<d.added.length;g++){var h=c.item.clone();h.attr("id","page_"+d.added[g]);c.item.after(h)}a("a.save_order").click();i()}},error:function(){c.item.remove()}})}},update:function(b,c){if(!c.item.hasClass("exteriorPage")){a("a.save_order").click();i()}}});
a("#contentSource li.newBlankPage").draggable({connectToSortable:".editing",helper:"clone",revert:"invalid"});a("#contentSource li.trashCan").droppable({accept:"ul.editing li, ul.exterior li",drop:function(b,c){var f=c.draggable.attr("id").replace("page_",""),d=c.helper.parents("ul.editing").length>0?o:p;if(c.draggable.find("img").length==0)return d(f);if(confirm("Are you sure you want to remove this page?"))return d(f);return false}});a("#contentSource li.exteriorConversion").droppable({accept:".editing li",
drop:function(b,c){convertPage(c.draggable.attr("id").replace("page_",""))}});a("a.save_order").click(function(b){b.preventDefault();a.ajax({url:a(this).attr("href"),data:a(".editing").sortable("serialize",{key:"page"}),dataType:"json",type:"POST",cache:false,success:function(c){c.success||alert(c.error)},error:function(){alert("There was an error saving the order")}})});j();a("#edit_annotations").click(function(){j();$this=a(this);if(a("#annotations").data("annotations_scroll")){$this.attr("title",
"Edit Annotations");$this.removeClass("stop_editing_annotations");$this.addClass("edit_annotations")}else{$this.attr("title","Stop Editing Annotations");$this.removeClass("edit_annotations");$this.addClass("stop_editing_annotations")}});a("form.annotation_form").live("submit",function(b){b.preventDefault();b=a(this);a.ajax({type:b.attr("method"),url:b.attr("action"),data:b.serialize(),dataType:"json",success:function(c){if(typeof c.errors!="undefined")alert(c.errors);else{a(document).trigger("close.facebox");
a("#reload_annotations").click()}},error:function(c,f){alert(f)}})});a("a.delete_annotation").live("click",function(b){b.preventDefault();confirm("Are you sure you want to delete the annotation?")&&a.ajax({url:a(this).attr("href"),dataType:"json",success:function(){a(document).trigger("close.facebox");a("#reload_annotations").click()},error:function(c,f){alert(f)}})});a("form.page_form").live("submit",function(b){b.preventDefault();b=a(this);if(b.hasClass("convert_page_form")){b.find("input[name=sequence]").val(0);
b.find("input[name=internal]").val("False")}a.ajax({type:b.attr("method"),url:b.attr("action"),data:b.serialize(),dataType:"json",success:function(c){if(typeof c.errors!="undefined")alert(c.errors);else{a(document).trigger("close.facebox");a(".editing #page_"+c.updated).remove();a("a.save_order").click();i()}},error:function(c,f){alert(f)}})});a("a#add_annotation").click(function(b){b.preventDefault();r(a(this).attr("href"))});a("#reload_annotations").click(function(b){b.preventDefault();a("#annotationsWrapper").load(a(this).attr("href"),
function(){j();j()})});m(".exterior li:has(img)");k(".exterior li:not(:has(img))");a(".exterior li:not(:has(img))").live("drop",function(b,c){var f=c.draggable.attr("id").replace("page_",""),d=a(this),g=d.children("div"),h=g.attr("id").replace("exterior_","");l(d.attr("id").replace("page_",""));a.ajax({url:"/page/"+f+"/convert/",type:"POST",data:{title:h,internal:"False",sequence:"0"},success:function(s){if(typeof s.updated=="number"){a(".editing #page_"+f).remove();d.droppable("destroy");g.removeClass("missingPage");
g.children("div").addClass("overlay");g.prepend(c.draggable.find("img"));d.attr("id",c.draggable.attr("id"));m(d);a("a.save_order").click()}}})});a(".editing").bind("sortstop",function(b,c){if(c.item.find("div.overlay").length>0){var f=c.item.attr("id").replace("page_",""),d=a(".exterior #"+c.item.attr("id")),g=d.children("div").attr("id").replace("exterior_","");a.ajax({url:"/page/"+f+"/convert/",type:"POST",data:{title:"",internal:"True",sequence:"0"},success:function(h){if(typeof h.updated!="undefined"){c.item.find("div.overlay").remove();
c.item.removeClass("exteriorPage");d.draggable("destroy");a("a.save_order").click()}}});a.ajax({url:a("a.add_page").attr("href"),type:"POST",data:{title:g,internal:"False",sequence:"0"},success:function(h){if(typeof h.added=="number"){d.find("img").remove();d.find("div.overlay").removeClass("overlay");d.children("div").addClass("missingPage");d.attr("id","page_"+h.added);k(d)}}})}});a(".page-annotations").facebox({overlay:false});a(".annotation-toggle").click(function(b){b.preventDefault();a("#annotationsWrapper").slideToggle("slow")});
n("ul.editing.frankenbook li");a("ul.copy li:has(img)").draggable({helper:"clone",revert:false});a("ul.editing.frankenbook li").live("drop",function(b,c){var f=a(this),d=f.attr("id").replace("page_","");d&&a.ajax({url:"/page/"+d+"/edit-urls/",type:"POST",data:{jp2:c.draggable.children("a").attr("href"),thumbnail:c.draggable.find("img.repository-thumbnail").attr("src")},success:function(){f.empty();f.append(c.draggable.children().clone(false));i()}})});a(".editing").bind("sortreceive sortremove",function(){a(this).filmstrip("resize")});
a("ul.editing.frankenbook").bind("sortstop",function(b,c){n(c.item)})})})(jQuery);
